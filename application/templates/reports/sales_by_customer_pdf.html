<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sales by Customer Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        @page { 
            margin: 1cm; 
            size: A4 landscape;
        }
        body { 
            font-size: 11px; 
            font-family: -webkit-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .card { 
            margin-bottom: 15px; 
            page-break-inside: avoid; 
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        .table { 
            font-size: 10px; 
        }
        .currency::before { 
            content: '₦'; 
        }
        .btn-toolbar, .btn-group, .btn {
            display: none !important;
        }
        .text-primary { color: #0d6efd !important; }
        .text-success { color: #198754 !important; }
        .text-danger { color: #dc3545 !important; }
        .text-warning { color: #ffc107 !important; }
        .text-info { color: #0dcaf0 !important; }
        .text-muted { color: #6c757d !important; }
        .text-secondary { color: #6c757d !important; }
        .bg-success { background-color: #198754 !important; color: white !important; }
        .bg-warning { background-color: #ffc107 !important; color: black !important; }
        .bg-primary { background-color: #0d6efd !important; color: white !important; }
        .table-warning { background-color: #fff3cd !important; }
        .table-info { background-color: #cff4fc !important; }
        .badge { padding: 0.25em 0.5em; font-size: 0.75em; border-radius: 0.375rem; }
        .bg-success.badge { background-color: #198754 !important; }
        .bg-warning.badge { background-color: #ffc107 !important; color: black !important; }
        .text-dark { color: #212529 !important; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Sales by Customer Report</h1>
            <div class="text-muted">
                Generated: {{ moment().strftime('%Y-%m-%d %H:%M') if moment is defined else "2025-01-15 12:00" }}
                | Sorted by: {{ sort_by.title() }}
            </div>
        </div>

        {% if customer_sales %}
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-primary">{{ customer_sales|length }}</h5>
                        <small class="text-muted">Total Customers</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-success"><span class="currency">{{ "%.2f"|format(customer_sales.values()|sum(attribute='net_revenue')) }}</span></h5>
                        <small class="text-muted">Total Revenue</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-info"><span class="currency">{{ "%.2f"|format(customer_sales.values()|sum(attribute='total_payments')) }}</span></h5>
                        <small class="text-muted">Total Received</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-warning"><span class="currency">{{ "%.2f"|format(customer_sales.values()|sum(attribute='outstanding_balance')) }}</span></h5>
                        <small class="text-muted">Outstanding</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Customer Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Customer Performance Analysis</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Qty Sold</th>
                                <th>Qty Refunded</th>
                                <th>Net Qty</th>
                                <th>Sales Amount</th>
                                <th>Payments Received</th>
                                <th>Outstanding</th>
                                <th>Transactions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for loop_customer_key, data in customer_sales.items() %}
                            {% set rank = loop.index %}
                            <tr class="{% if rank <= 3 %}table-warning{% endif %}">
                                <td>
                                    <strong class="{% if rank == 1 %}text-warning{% elif rank == 2 %}text-secondary{% elif rank == 3 %}text-success{% endif %}">
                                        #{{ rank }}
                                        {% if rank == 1 %}<i class="bi bi-trophy"></i>{% endif %}
                                    </strong>
                                </td>
                                <td>
                                    <strong>{{ data.customer_name }}</strong>
                                </td>
                                <td>{{ data.customer_phone }}</td>
                                <td>
                                    <span class="badge bg-success">{{ data.total_quantity_sold }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-warning text-dark">{{ data.total_quantity_refunded }}</span>
                                </td>
                                <td>
                                    <strong class="{% if data.net_quantity > 0 %}text-success{% else %}text-muted{% endif %}">
                                        {{ data.net_quantity }}
                                    </strong>
                                </td>
                                <td><span class="currency">{{ "%.2f"|format(data.net_revenue) }}</span></td>
                                <td><span class="currency">{{ "%.2f"|format(data.total_payments) }}</span></td>
                                <td>
                                    <strong class="{% if data.outstanding_balance > 0 %}text-danger{% elif data.outstanding_balance < 0 %}text-success{% else %}text-muted{% endif %}">
                                        <span class="currency">{{ "%.2f"|format(data.outstanding_balance|abs) }}</span>
                                        {% if data.outstanding_balance > 0 %}
                                        <i class="bi bi-arrow-up" title="Customer owes"></i>
                                        {% elif data.outstanding_balance < 0 %}
                                        <i class="bi bi-arrow-down" title="We owe customer"></i>
                                        {% endif %}
                                    </strong>
                                </td>
                                <td>
                                    <small>
                                        {{ data.total_transactions }} total
                                        <br>{{ data.sales_count }} sales
                                        {% if data.refund_count %}, {{ data.refund_count }} refunds{% endif %}
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <th colspan="3">Total</th>
                                <th>{{ customer_sales.values()|sum(attribute='total_quantity_sold') }}</th>
                                <th>{{ customer_sales.values()|sum(attribute='total_quantity_refunded') }}</th>
                                <th>{{ customer_sales.values()|sum(attribute='net_quantity') }}</th>
                                <th><span class="currency">{{ "%.2f"|format(customer_sales.values()|sum(attribute='net_revenue')) }}</span></th>
                                <th><span class="currency">{{ "%.2f"|format(customer_sales.values()|sum(attribute='total_payments')) }}</span></th>
                                <th><strong><span class="currency">{{ "%.2f"|format(customer_sales.values()|sum(attribute='outstanding_balance')) }}</span></strong></th>
                                <th>-</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customer Insights -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Customer Insights</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-lightbulb"></i> Top Performer:</h6>
                            {% if customer_sales %}
                            {% set top_customer = customer_sales.values()|list|first %}
                            <strong>{{ top_customer.customer_name }}</strong> leads with 
                            {% if sort_by == 'quantity' %}
                            {{ top_customer.net_quantity }} units sold
                            {% elif sort_by == 'transactions' %}
                            {{ top_customer.total_transactions }} transactions
                            {% else %}
                            ₦{{ "%.2f"|format(top_customer.net_revenue) }} in revenue
                            {% endif %}
                            {% else %}
                            No customer data available yet.
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-warning">
                            <h6><i class="bi bi-exclamation-triangle"></i> Outstanding Balances:</h6>
                            {% if customer_sales %}
                            {% set customers_with_balance = customer_sales.values()|selectattr('outstanding_balance', 'greaterthan', 0)|list|length %}
                            {{ customers_with_balance }} customers have outstanding balances totaling 
                            <strong>₦{{ "%.2f"|format(customer_sales.values()|selectattr('outstanding_balance', 'greaterthan', 0)|sum(attribute='outstanding_balance')) }}</strong>
                            {% else %}
                            No outstanding balances to report.
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-people display-1 text-muted"></i>
            <h3 class="mt-3">No Customer Sales Data</h3>
            <p class="text-muted">No sales have been recorded yet.</p>
        </div>
        {% endif %}
    </div>
</body>
</html>