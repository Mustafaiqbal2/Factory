{% extends "layout.html" %}

{% block title %}Account Report{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Account Report</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('reports.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Reports
            </a>
        </div>
    </div>
</div>

<!-- Customer Selection -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Select Customer</h5>
    </div>
    <div class="card-body">
        <form method="GET">
            <div class="row">
                <div class="col-md-8">
                    <select class="form-select" name="customer" id="customer_select" onchange="updatePhone()">
                        <option value="">Select a customer</option>
                        {% for customer in customers %}
                        <option value="{{ customer.name }}" 
                                data-phone="{{ customer.phone }}"
                                {% if request.args.get('customer') == customer.name %}selected{% endif %}>
                            {{ customer.name }} - {{ customer.phone }}
                            {% if customer.company %}({{ customer.company }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <input type="hidden" name="phone" id="phone_input" value="{{ request.args.get('phone', '') }}">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Generate Report
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if account_data %}
<!-- Account Summary -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Account Summary - {{ account_data.customer_name }}</h5>
                <a href="{{ url_for('reports.export_account_pdf', customer=account_data.customer_name, phone=account_data.customer_phone) }}" 
                   class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-file-earmark-pdf"></i> Export PDF
                </a>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Customer:</strong> {{ account_data.customer_name }}<br>
                        <strong>Phone:</strong> {{ account_data.customer_phone }}
                    </div>
                    <div class="col-md-6">
                        <strong>Report Date:</strong> {{ moment().strftime('%Y-%m-%d') if moment is defined else "2025-01-15" }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Account Balance</h5>
            </div>
            <div class="card-body text-center">
                <h3 class="{% if account_data.balance > 0 %}text-danger{% elif account_data.balance < 0 %}text-success{% else %}text-muted{% endif %}">
                    <span class="currency">{{ "%.2f"|format(account_data.balance|abs) }}</span>
                </h3>
                <small class="text-muted">
                    {% if account_data.balance > 0 %}
                    <span class="text-danger">Customer Owes Us</span>
                    {% elif account_data.balance < 0 %}
                    <span class="text-success">We Owe Customer</span>
                    {% else %}
                    Account Settled
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- T-Account Ledger -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-journal-text"></i> T-Account Ledger
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Debit Side (What Customer Owes) -->
            <div class="col-md-6">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white text-center">
                        <h6 class="mb-0">DEBIT - Customer Owes (Red)</h6>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set debit_total = 0 %}
                                {% for sale in account_data.sales %}
                                    {% if not sale.is_refund %}
                                    <tr>
                                        <td><small>{{ sale.date[:10] if sale.date else 'N/A' }}</small></td>
                                        <td><small>Sale #{{ sale.sale_id }}</small></td>
                                        <td class="text-end text-danger"><span class="currency">{{ "%.2f"|format(sale.total) }}</span></td>
                                    </tr>
                                    {% set debit_total = debit_total + sale.total %}
                                    {% endif %}
                                {% endfor %}
                                {% for transaction in account_data.transactions %}
                                    {% if transaction.type == 'advance' %}
                                    <tr>
                                        <td><small>{{ transaction.date[:10] if transaction.date else 'N/A' }}</small></td>
                                        <td><small>Advance Given</small></td>
                                        <td class="text-end text-danger"><span class="currency">{{ "%.2f"|format(transaction.amount) }}</span></td>
                                    </tr>
                                    {% set debit_total = debit_total + transaction.amount %}
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-danger">
                                <tr>
                                    <th colspan="2">Total Debit</th>
                                    <th class="text-end"><span class="currency">{{ "%.2f"|format(debit_total) }}</span></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Credit Side (What We Owe Customer) -->
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-header bg-success text-white text-center">
                        <h6 class="mb-0">CREDIT - We Owe (Green)</h6>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set credit_total = 0 %}
                                {% for sale in account_data.sales %}
                                    {% if sale.is_refund %}
                                    <tr>
                                        <td><small>{{ sale.date[:10] if sale.date else 'N/A' }}</small></td>
                                        <td><small>Refund #{{ sale.sale_id }}</small></td>
                                        <td class="text-end text-success"><span class="currency">{{ "%.2f"|format(sale.total) }}</span></td>
                                    </tr>
                                    {% set credit_total = credit_total + sale.total %}
                                    {% endif %}
                                {% endfor %}
                                {% for payment in account_data.payments %}
                                    <tr>
                                        <td><small>{{ payment.date[:10] if payment.date else 'N/A' }}</small></td>
                                        <td><small>{{ payment.description or 'Payment Received' }}</small></td>
                                        <td class="text-end text-success"><span class="currency">{{ "%.2f"|format(payment.amount) }}</span></td>
                                    </tr>
                                    {% set credit_total = credit_total + payment.amount %}
                                {% endfor %}
                                {% for transaction in account_data.transactions %}
                                    {% if transaction.type == 'payment' %}
                                    <tr>
                                        <td><small>{{ transaction.date[:10] if transaction.date else 'N/A' }}</small></td>
                                        <td><small>{{ transaction.note or 'Payment' }}</small></td>
                                        <td class="text-end text-success"><span class="currency">{{ "%.2f"|format(transaction.amount) }}</span></td>
                                    </tr>
                                    {% set credit_total = credit_total + transaction.amount %}
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-success">
                                <tr>
                                    <th colspan="2">Total Credit</th>
                                    <th class="text-end"><span class="currency">{{ "%.2f"|format(credit_total) }}</span></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Balance Summary -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card {% if account_data.balance > 0 %}border-danger{% elif account_data.balance < 0 %}border-success{% else %}border-secondary{% endif %}">
                    <div class="card-body text-center">
                        <h5 class="mb-1">Account Balance</h5>
                        <h3 class="{% if account_data.balance > 0 %}text-danger{% elif account_data.balance < 0 %}text-success{% else %}text-muted{% endif %}">
                            <span class="currency">{{ "%.2f"|format(account_data.balance|abs) }}</span>
                        </h3>
                        <p class="mb-0">
                            {% if account_data.balance > 0 %}
                            <span class="text-danger"><i class="bi bi-arrow-up-circle"></i> Customer owes us this amount</span>
                            {% elif account_data.balance < 0 %}
                            <span class="text-success"><i class="bi bi-arrow-down-circle"></i> We owe customer this amount</span>
                            {% else %}
                            <span class="text-muted"><i class="bi bi-check-circle"></i> Account is balanced</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('sale.add') }}?customer={{ account_data.customer_name }}&phone={{ account_data.customer_phone }}" 
                       class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> New Sale
                    </a>
                    <a href="{{ url_for('payment.add') }}?customer={{ account_data.customer_name }}&phone={{ account_data.customer_phone }}" 
                       class="btn btn-success">
                        <i class="bi bi-cash"></i> Record Payment
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Account Summary</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h6 class="text-danger">Total Sales</h6>
                            <h5><span class="currency">{{ "%.2f"|format(account_data.total_sales) }}</span></h5>
                        </div>
                    </div>
                    <div class="col-6">
                        <h6 class="text-success">Total Received</h6>
                        <h5><span class="currency">{{ "%.2f"|format(account_data.total_payments) }}</span></h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function updatePhone() {
    const select = document.getElementById('customer_select');
    const phoneInput = document.getElementById('phone_input');
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption.value) {
        phoneInput.value = selectedOption.dataset.phone;
    } else {
        phoneInput.value = '';
    }
}
</script>
{% endblock %}