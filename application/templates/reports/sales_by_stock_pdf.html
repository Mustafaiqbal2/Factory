<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sales by Stock Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        @page { 
            margin: 1cm; 
            size: A4;
        }
        body { 
            font-size: 12px; 
            font-family: -webkit-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .card { 
            margin-bottom: 15px; 
            page-break-inside: avoid; 
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        .table { 
            font-size: 11px; 
        }
        .currency::before { 
            content: '₦'; 
        }
        .btn-toolbar, .btn-group, .btn {
            display: none !important;
        }
        .text-primary { color: #0d6efd !important; }
        .text-success { color: #198754 !important; }
        .text-danger { color: #dc3545 !important; }
        .text-warning { color: #ffc107 !important; }
        .text-info { color: #0dcaf0 !important; }
        .text-muted { color: #6c757d !important; }
        .bg-success { background-color: #198754 !important; color: white !important; }
        .bg-warning { background-color: #ffc107 !important; color: black !important; }
        .bg-primary { background-color: #0d6efd !important; color: white !important; }
        .badge { padding: 0.25em 0.5em; font-size: 0.75em; border-radius: 0.375rem; }
        .table-info { background-color: #cff4fc !important; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Sales by Stock Report</h1>
            <div class="text-muted">
                Generated: {{ moment().strftime('%Y-%m-%d %H:%M') if moment is defined else "2025-01-15 12:00" }}
                | Grouped by: {{ group_by.title() }}
            </div>
        </div>

        {% if stock_sales %}
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-primary">{{ stock_sales|length }}</h5>
                        <small class="text-muted">Total {{ group_by.title() }}s</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-success">{{ stock_sales.values()|sum(attribute='total_quantity_sold') }}</h5>
                        <small class="text-muted">Units Sold</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-info"><span class="currency">{{ "%.2f"|format(stock_sales.values()|sum(attribute='total_sales_amount')) }}</span></h5>
                        <small class="text-muted">Total Revenue</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-warning">{{ stock_sales.values()|sum(attribute='sales_count') }}</h5>
                        <small class="text-muted">Total Sales</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Stock Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Sales Performance by {{ group_by.title() }}</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>{{ group_by.title() }}</th>
                                <th>Qty Sold</th>
                                <th>Qty Refunded</th>
                                <th>Net Qty</th>
                                <th>Sales Amount</th>
                                <th>Refund Amount</th>
                                <th>Net Revenue</th>
                                <th>Sales Count</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key, data in stock_sales.items() %}
                            {% set rank = loop.index %}
                            {% set net_qty = data.total_quantity_sold - data.total_quantity_refunded %}
                            {% set net_revenue = data.total_sales_amount - data.total_refund_amount %}
                            <tr>
                                <td>
                                    <strong class="{% if rank <= 3 %}text-success{% endif %}">
                                        #{{ rank }}
                                        {% if rank == 1 %}<i class="bi bi-trophy"></i>{% endif %}
                                    </strong>
                                </td>
                                <td><strong>{{ data.group_name }}</strong></td>
                                <td>
                                    <span class="badge bg-success">{{ data.total_quantity_sold }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-warning text-dark">{{ data.total_quantity_refunded }}</span>
                                </td>
                                <td>
                                    <strong class="{% if net_qty > 0 %}text-success{% else %}text-muted{% endif %}">
                                        {{ net_qty }}
                                    </strong>
                                </td>
                                <td><span class="currency">{{ "%.2f"|format(data.total_sales_amount) }}</span></td>
                                <td><span class="currency">{{ "%.2f"|format(data.total_refund_amount) }}</span></td>
                                <td>
                                    <strong class="{% if net_revenue > 0 %}text-success{% elif net_revenue < 0 %}text-danger{% else %}text-muted{% endif %}">
                                        <span class="currency">{{ "%.2f"|format(net_revenue) }}</span>
                                    </strong>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ data.sales_count }}</span>
                                    {% if data.refund_count %}<br><small class="text-muted">{{ data.refund_count }} refunds</small>{% endif %}
                                </td>
                                <td>
                                    {% if net_revenue > 1000 %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-arrow-up"></i> Excellent
                                    </span>
                                    {% elif net_revenue > 500 %}
                                    <span class="badge bg-info">
                                        <i class="bi bi-arrow-up-right"></i> Good
                                    </span>
                                    {% elif net_revenue > 0 %}
                                    <span class="badge bg-warning">
                                        <i class="bi bi-arrow-right"></i> Fair
                                    </span>
                                    {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="bi bi-dash"></i> Low
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <th colspan="2">Total</th>
                                <th>{{ stock_sales.values()|sum(attribute='total_quantity_sold') }}</th>
                                <th>{{ stock_sales.values()|sum(attribute='total_quantity_refunded') }}</th>
                                <th>{{ stock_sales.values()|sum(attribute='total_quantity_sold') - stock_sales.values()|sum(attribute='total_quantity_refunded') }}</th>
                                <th><span class="currency">{{ "%.2f"|format(stock_sales.values()|sum(attribute='total_sales_amount')) }}</span></th>
                                <th><span class="currency">{{ "%.2f"|format(stock_sales.values()|sum(attribute='total_refund_amount')) }}</span></th>
                                <th><strong><span class="currency">{{ "%.2f"|format(stock_sales.values()|sum(attribute='total_sales_amount') - stock_sales.values()|sum(attribute='total_refund_amount')) }}</span></strong></th>
                                <th>{{ stock_sales.values()|sum(attribute='sales_count') }}</th>
                                <th>-</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Performance Insights -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Performance Insights</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-trophy"></i> Top Performer:</h6>
                            {% if stock_sales %}
                            {% set top_item = stock_sales.values()|list|first %}
                            <strong>{{ top_item.group_name }}</strong> leads with {{ top_item.total_quantity_sold }} units sold 
                            and ₦{{ "%.2f"|format(top_item.total_sales_amount - top_item.total_refund_amount) }} net revenue.
                            {% else %}
                            No sales data available yet.
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-success">
                            <h6><i class="bi bi-graph-up"></i> Sales Summary:</h6>
                            {% if stock_sales %}
                            Total {{ stock_sales|length }} {{ group_by }}(s) generated 
                            <strong>₦{{ "%.2f"|format(stock_sales.values()|sum(attribute='total_sales_amount') - stock_sales.values()|sum(attribute='total_refund_amount')) }}</strong> 
                            in net revenue from {{ stock_sales.values()|sum(attribute='sales_count') }} sales.
                            {% else %}
                            No sales summary available.
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-box display-1 text-muted"></i>
            <h3 class="mt-3">No Stock Sales Data</h3>
            <p class="text-muted">No sales have been recorded yet.</p>
        </div>
        {% endif %}
    </div>
</body>
</html>